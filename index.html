<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backchannel ‚Äî Braintrust</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0d0d0d; --surface: #161616; --surface2: #1e1e1e;
    --border: #262626; --border-hover: #404040;
    --text: #f0ede8; --text-muted: #5a5a5a; --text-dim: #888;
    --accent: #e8d5a3; --accent-dim: rgba(232,213,163,0.08); --accent-border: rgba(232,213,163,0.2);
    --green: #a8d5b5; --green-dim: rgba(168,213,181,0.08);
    --red: #d5a8a8; --radius: 8px;
    --mono: 'DM Mono', monospace; --sans: 'DM Sans', sans-serif;
  }
  body { background: var(--bg); color: var(--text); font-family: var(--sans); min-height: 100vh; font-size: 14px; }

  header { border-bottom: 1px solid var(--border); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: rgba(13,13,13,0.97); backdrop-filter: blur(8px); z-index: 100; }
  .logo { display: flex; align-items: center; gap: 10px; font-family: var(--mono); font-size: 13px; color: var(--text-muted); }
  .logo-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--accent); animation: pulse 2.5s ease-in-out infinite; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
  .logo strong { color: var(--text); font-weight: 500; }
  .header-right { display: flex; gap: 8px; }

  .tabs { display: flex; padding: 20px 32px 0; border-bottom: 1px solid var(--border); gap: 2px; }
  .tab { padding: 8px 18px; font-size: 13px; font-weight: 500; color: var(--text-muted); background: none; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; cursor: pointer; transition: all 0.15s; font-family: var(--sans); }
  .tab:hover { color: var(--text-dim); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

  main { padding: 28px 32px; max-width: 860px; margin: 0 auto; }
  .panel { display: none; }
  .panel.active { display: block; }

  /* Search */
  .search-wrap { position: relative; margin-bottom: 12px; }
  .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 18px; pointer-events: none; }
  .search-input { width: 100%; padding: 13px 16px 13px 46px; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-family: var(--sans); font-size: 15px; outline: none; transition: border-color 0.15s; }
  .search-input:focus { border-color: var(--accent); }
  .search-input::placeholder { color: var(--text-muted); }

  .filters { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
  .filter-chip { display: flex; align-items: center; gap: 7px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 5px 14px; }
  .filter-chip label { font-family: var(--mono); font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; white-space: nowrap; }
  .filter-chip input[type="number"] { width: 58px; background: transparent; border: none; outline: none; color: var(--text); font-size: 12px; font-family: var(--mono); padding: 0; }
  .filter-chip select { background: transparent; border: none; outline: none; color: var(--text); font-size: 12px; font-family: var(--sans); padding: 0; cursor: pointer; appearance: none; }
  .filter-sep { color: var(--text-muted); font-size: 11px; }
  .filter-opt { font-family: var(--mono); font-size: 10px; color: var(--text-muted); opacity: 0.6; font-style: italic; }

  .db-meta { font-family: var(--mono); font-size: 11px; color: var(--text-muted); margin-bottom: 20px; }

  .empty { text-align: center; padding: 64px 20px; color: var(--text-muted); }
  .empty-icon { font-size: 30px; opacity: 0.25; margin-bottom: 14px; }
  .empty p { font-size: 14px; }
  .empty .hint { font-size: 12px; margin-top: 6px; opacity: 0.6; }

  .result-meta { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 14px; }
  .result-label { font-family: var(--mono); font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; }
  .result-count { font-family: var(--mono); font-size: 12px; color: var(--accent); }

  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 8px; overflow: hidden; transition: border-color 0.15s; }
  .card:hover { border-color: var(--border-hover); }
  .card-header { display: flex; align-items: center; gap: 13px; padding: 13px 18px; }
  .avatar { width: 33px; height: 33px; border-radius: 50%; background: var(--accent-dim); border: 1px solid var(--accent-border); display: flex; align-items: center; justify-content: center; font-family: var(--mono); font-size: 11px; color: var(--accent); flex-shrink: 0; font-weight: 500; }
  .person-info { flex: 1; min-width: 0; }
  .person-name { font-weight: 600; font-size: 14px; color: var(--text); }
  .person-sub { font-size: 11px; color: var(--text-muted); font-family: var(--mono); margin-top: 2px; display: flex; gap: 10px; }
  .person-loc-badge { color: var(--text-dim); }

  .card-actions { display: flex; gap: 6px; opacity: 0; transition: opacity 0.15s; }
  .card:hover .card-actions { opacity: 1; }

  .stints { border-top: 1px solid var(--border); }
  .stint { display: grid; grid-template-columns: 1fr 120px; gap: 10px; align-items: center; padding: 9px 18px; border-bottom: 1px solid var(--border); }
  .stint:last-child { border-bottom: none; }
  .stint.hit { background: var(--accent-dim); }
  .stint-co { font-size: 13px; font-weight: 500; color: var(--text-dim); }
  .stint.hit .stint-co { color: var(--accent); }
  .stint-years { font-family: var(--mono); font-size: 11px; color: var(--text-muted); }
  .stint.hit .stint-years { color: rgba(232,213,163,0.55); }

  /* Edit modal */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; }
  .modal-overlay.open { display: flex; }
  .modal { background: #141414; border: 1px solid var(--border); border-radius: 10px; padding: 28px; width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; }
  .modal-title { font-size: 15px; font-weight: 600; margin-bottom: 20px; color: var(--text); }

  /* Forms */
  .form-section { font-family: var(--mono); font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; padding-bottom: 8px; border-bottom: 1px solid var(--border); margin-bottom: 14px; margin-top: 22px; }
  .form-section:first-child { margin-top: 0; }
  .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 4px; }
  .fg { display: flex; flex-direction: column; gap: 5px; }
  .fl { font-family: var(--mono); font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; }
  input[type="text"], input[type="number"], select {
    width: 100%; background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    color: var(--text); font-family: var(--sans); font-size: 13px; padding: 8px 11px; outline: none; transition: border-color 0.15s;
  }
  input:focus, select:focus { border-color: var(--border-hover); }
  input::placeholder { color: var(--text-muted); }
  select { appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' fill='none'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23555' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 10px center; padding-right: 28px; cursor: pointer; }

  .stint-row-form { display: grid; grid-template-columns: 2fr 0.8fr 0.8fr; gap: 10px; margin-bottom: 10px; align-items: end; }
  .stint-row-num { font-family: var(--mono); font-size: 10px; color: var(--text-muted); margin-bottom: 4px; }
  .form-actions { display: flex; gap: 10px; margin-top: 20px; }
  .form-actions-right { margin-left: auto; }

  /* Buttons */
  .btn { padding: 8px 18px; border-radius: var(--radius); font-family: var(--sans); font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; }
  .btn-primary { background: var(--accent); color: #0d0d0d; }
  .btn-primary:hover { background: #f0e0b0; }
  .btn-ghost { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
  .btn-ghost:hover { border-color: var(--border-hover); color: var(--text); }
  .btn-sm { padding: 5px 11px; font-size: 12px; }
  .btn-red { background: transparent; color: var(--red); border: 1px solid rgba(213,168,168,0.15); }
  .btn-red:hover { background: rgba(213,168,168,0.07); }

  /* Upload */
  .csv-spec { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px 18px; margin-bottom: 16px; }
  .csv-spec pre { font-family: var(--mono); font-size: 11px; color: var(--text-dim); overflow-x: auto; margin-top: 8px; line-height: 2; white-space: pre; }

  .upload-mode { display: flex; gap: 8px; margin-bottom: 16px; }
  .mode-btn { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); background: var(--surface); color: var(--text-muted); font-family: var(--sans); font-size: 13px; cursor: pointer; transition: all 0.15s; text-align: center; }
  .mode-btn:hover { border-color: var(--border-hover); color: var(--text-dim); }
  .mode-btn.active { border-color: var(--accent-border); background: var(--accent-dim); color: var(--accent); }
  .mode-label { font-weight: 600; font-size: 13px; margin-bottom: 2px; }
  .mode-desc { font-size: 11px; opacity: 0.7; font-family: var(--mono); }

  .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 44px; text-align: center; cursor: pointer; transition: all 0.15s; margin-bottom: 16px; }
  .upload-zone:hover, .upload-zone.over { border-color: var(--accent); background: var(--accent-dim); }
  .upload-zone input { display: none; }
  .upload-icon { font-size: 26px; margin-bottom: 10px; opacity: 0.35; }
  .upload-title { font-size: 14px; font-weight: 500; margin-bottom: 5px; }
  .upload-sub { font-size: 12px; color: var(--text-muted); }
  .upload-row { display: flex; align-items: center; gap: 12px; }
  .upload-status { font-size: 12px; color: var(--text-muted); font-family: var(--mono); }

  /* Toast */
  .toast { position: fixed; bottom: 24px; right: 24px; padding: 11px 18px; border-radius: var(--radius); font-size: 13px; font-weight: 500; z-index: 999; opacity: 0; transform: translateY(6px); transition: all 0.2s; pointer-events: none; }
  .toast.show { opacity: 1; transform: translateY(0); }
  .toast.ok { background: var(--green-dim); border: 1px solid rgba(168,213,181,0.25); color: var(--green); }
  .toast.err { background: rgba(213,168,168,0.07); border: 1px solid rgba(213,168,168,0.25); color: var(--red); }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-dot"></div>
    <strong>Backchannel</strong>&nbsp;/&nbsp;Braintrust Internal
  </div>
  <div class="header-right">
    <button class="btn btn-ghost btn-sm" onclick="go('upload')">‚Üë Upload CSV</button>
    <button class="btn btn-primary btn-sm" onclick="go('add')">+ Add Person</button>
  </div>
</header>

<div class="tabs">
  <button class="tab active" id="tab-search" onclick="go('search')">Search</button>
  <button class="tab" id="tab-add" onclick="go('add')">Add Person</button>
  <button class="tab" id="tab-upload" onclick="go('upload')">Upload CSV</button>
</div>

<main>

  <!-- SEARCH -->
  <div class="panel active" id="panel-search">
    <div class="search-wrap">
      <span class="search-icon">‚åï</span>
      <input class="search-input" type="text" id="q" placeholder="Search by company ‚Äî e.g. Datadog, Grafana, Snowflake‚Ä¶" oninput="search()">
    </div>
    <div class="filters">
      <div class="filter-chip">
        <label>Years <span class="filter-opt">optional</span></label>
        <input type="number" id="yfrom" placeholder="2018" oninput="search()">
        <span class="filter-sep">‚Äì</span>
        <input type="number" id="yto" placeholder="2024" oninput="search()">
      </div>
    </div>
    <div class="db-meta" id="dbmeta"></div>
    <div id="results">
      <div class="empty">
        <div class="empty-icon">‚óé</div>
        <p>Search a company to see who can backchannel</p>
        <p class="hint">Shows name, current location, Braintrust role, and years at that company</p>
      </div>
    </div>
  </div>

  <!-- ADD -->
  <div class="panel" id="panel-add">
    <div class="form-section">Person</div>
    <div class="form-grid">
      <div class="fg"><label class="fl">Full Name</label><input type="text" id="aname" placeholder="Phil Hetzel"></div>
      <div class="fg"><label class="fl">Current Location</label>
        <select id="aloc">
          <option value="">‚Äî</option>
          <option>SF</option><option>NYC</option><option>LA</option>
          <option>Seattle</option><option>Austin</option><option>Chicago</option>
          <option>Boston</option><option>London</option><option>Remote</option><option>Other</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Braintrust Role</label><input type="text" id="arole" placeholder="VP Field Engineering"></div>
    </div>

    <div class="form-section">Previous Companies</div>

    <div class="stint-row-num">Company 1</div>
    <div class="stint-row-form">
      <div class="fg"><label class="fl">Company</label><input type="text" id="c1n" placeholder="Grafana Labs"></div>
      <div class="fg"><label class="fl">Start</label><input type="number" id="c1s" placeholder="2021"></div>
      <div class="fg"><label class="fl">End</label><input type="number" id="c1e" placeholder="2024"></div>
    </div>
    <div class="stint-row-num">Company 2</div>
    <div class="stint-row-form">
      <div class="fg"><label class="fl">Company</label><input type="text" id="c2n" placeholder="Datadog"></div>
      <div class="fg"><label class="fl">Start</label><input type="number" id="c2s" placeholder="2018"></div>
      <div class="fg"><label class="fl">End</label><input type="number" id="c2e" placeholder="2021"></div>
    </div>
    <div class="stint-row-num">Company 3</div>
    <div class="stint-row-form">
      <div class="fg"><label class="fl">Company</label><input type="text" id="c3n" placeholder="New Relic"></div>
      <div class="fg"><label class="fl">Start</label><input type="number" id="c3s" placeholder="2015"></div>
      <div class="fg"><label class="fl">End</label><input type="number" id="c3e" placeholder="2018"></div>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" onclick="addPerson()">Save Person</button>
      <button class="btn btn-ghost" onclick="clearForm()">Clear</button>
    </div>
  </div>

  <!-- UPLOAD -->
  <div class="panel" id="panel-upload">
    <div class="csv-spec">
      <div class="fl">Expected CSV format ‚Äî 12 columns, one row per person</div>
      <pre>Name, Current Location, Braintrust Role, Company 1, Start 1, End 1, Company 2, Start 2, End 2, Company 3, Start 3, End 3
Phil Hetzel, SF, VP Field Engineering, Grafana Labs, 2021, 2024, Datadog, 2018, 2021, New Relic, 2015, 2018
Bryan Cox, SF, CRO, Grafana Labs, 2020, 2023, Splunk, 2017, 2020</pre>
    </div>

    <div class="upload-mode">
      <div class="mode-btn active" id="mode-replace" onclick="setMode('replace')">
        <div class="mode-label">Replace all</div>
        <div class="mode-desc">Overwrites existing data</div>
      </div>
      <div class="mode-btn" id="mode-append" onclick="setMode('append')">
        <div class="mode-label">Append</div>
        <div class="mode-desc">Adds to existing data</div>
      </div>
    </div>

    <div class="upload-zone" id="dropzone" onclick="document.getElementById('csvfile').click()">
      <input type="file" id="csvfile" accept=".csv" onchange="handleCSV(event)">
      <div class="upload-icon">‚á™</div>
      <div class="upload-title">Drop CSV here or click to upload</div>
      <div class="upload-sub" id="upload-sub-text">Replaces all existing data</div>
    </div>
    <div class="upload-row">
      <button class="btn btn-ghost btn-sm btn-red" onclick="clearAll()">Clear all data</button>
      <span class="upload-status" id="upstatus"></span>
    </div>
  </div>

</main>

<!-- EDIT MODAL -->
<div class="modal-overlay" id="editModal">
  <div class="modal">
    <div class="modal-title">Edit Person</div>
    <input type="hidden" id="editId">

    <div class="form-section">Person</div>
    <div class="form-grid">
      <div class="fg"><label class="fl">Full Name</label><input type="text" id="ename" placeholder="Phil Hetzel"></div>
      <div class="fg"><label class="fl">Current Location</label>
        <select id="eloc">
          <option value="">‚Äî</option>
          <option>SF</option><option>NYC</option><option>LA</option>
          <option>Seattle</option><option>Austin</option><option>Chicago</option>
          <option>Boston</option><option>London</option><option>Remote</option><option>Other</option>
        </select>
      </div>
      <div class="fg"><label class="fl">Braintrust Role</label><input type="text" id="erole" placeholder="VP Field Engineering"></div>
    </div>

    <div class="form-section">Previous Companies</div>
    <div class="stint-row-num">Company 1</div>
    <div class="stint-row-form">
      <div class="fg"><label class="fl">Company</label><input type="text" id="ec1n"></div>
      <div class="fg"><label class="fl">Start</label><input type="number" id="ec1s"></div>
      <div class="fg"><label class="fl">End</label><input type="number" id="ec1e"></div>
    </div>
    <div class="stint-row-num">Company 2</div>
    <div class="stint-row-form">
      <div class="fg"><label class="fl">Company</label><input type="text" id="ec2n"></div>
      <div class="fg"><label class="fl">Start</label><input type="number" id="ec2s"></div>
      <div class="fg"><label class="fl">End</label><input type="number" id="ec2e"></div>
    </div>
    <div class="stint-row-num">Company 3</div>
    <div class="stint-row-form">
      <div class="fg"><label class="fl">Company</label><input type="text" id="ec3n"></div>
      <div class="fg"><label class="fl">Start</label><input type="number" id="ec3s"></div>
      <div class="fg"><label class="fl">End</label><input type="number" id="ec3e"></div>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <div class="form-actions-right">
        <button class="btn btn-red btn-sm" onclick="deleteFromModal()">Remove Person</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const KEY = 'bc_v4';
const load = () => { try { return JSON.parse(localStorage.getItem(KEY)) || []; } catch { return []; } };
const save = d => { localStorage.setItem(KEY, JSON.stringify(d)); updateMeta(); };

let uploadMode = 'replace';

function setMode(m) {
  uploadMode = m;
  document.getElementById('mode-replace').classList.toggle('active', m === 'replace');
  document.getElementById('mode-append').classList.toggle('active', m === 'append');
  document.getElementById('upload-sub-text').textContent = m === 'replace' ? 'Replaces all existing data' : 'Adds to existing data ‚Äî duplicates will be skipped';
}

function updateMeta() {
  const n = load().length;
  document.getElementById('dbmeta').textContent = n === 0
    ? 'No people in database ‚Äî add someone or upload a CSV'
    : `${n} people in database`;
}

function initials(n) { return n.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2); }

function stints(p) {
  const s = [];
  for (let i = 1; i <= 3; i++) if (p[`c${i}n`]) s.push({ co: p[`c${i}n`], s: p[`c${i}s`], e: p[`c${i}e`] });
  return s;
}

function go(tab) {
  ['search','add','upload'].forEach(t => {
    document.getElementById(`panel-${t}`).classList.toggle('active', t === tab);
    document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
  });
  if (tab === 'search') { updateMeta(); search(); }
}

function search() {
  const q = document.getElementById('q').value.trim().toLowerCase();
  const yf = parseInt(document.getElementById('yfrom').value) || null;
  const yt = parseInt(document.getElementById('yto').value) || null;
  const el = document.getElementById('results');

  if (!q && !yf && !yt) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">‚óé</div><p>Search a company to see who can backchannel</p><p class="hint">Shows name, current location, Braintrust role, and years at that company</p></div>`;
    return;
  }

  const matches = load().reduce((acc, p) => {
    const ss = stints(p);
    const hits = ss.filter(s => {
      if (q && !s.co.toLowerCase().includes(q)) return false;
      const start = parseInt(s.s) || 0, end = parseInt(s.e) || 9999;
      if (yf && yt && !(start <= yt && end >= yf)) return false;
      if (yf && !yt && end < yf) return false;
      if (!yf && yt && start > yt) return false;
      return true;
    });
    if (hits.length) acc.push({ p, ss, hits });
    return acc;
  }, []);

  if (!matches.length) {
    el.innerHTML = `<div class="empty"><div class="empty-icon">‚óé</div><p>No matches found</p><p class="hint">Try a different company name or remove the year filter</p></div>`;
    return;
  }

  const header = `<div class="result-meta"><span class="result-label">Results</span><span class="result-count">${matches.length} ${matches.length === 1 ? 'person' : 'people'}</span></div>`;

  const cards = matches.map(({ p, ss, hits }) => {
    const rows = ss.map(s => {
      const isHit = hits.some(h => h.co === s.co && h.s === s.s);
      const yr = (s.s || s.e) ? `${s.s || '?'} ‚Äì ${s.e || 'present'}` : '‚Äî';
      return `<div class="stint${isHit ? ' hit' : ''}">
        <span class="stint-co">${s.co}</span>
        <span class="stint-years">${yr}</span>
      </div>`;
    }).join('');

    const locBadge = p.loc ? `<span class="person-loc-badge">üìç ${p.loc}</span>` : '';

    return `<div class="card">
      <div class="card-header">
        <div class="avatar">${initials(p.name)}</div>
        <div class="person-info">
          <div class="person-name">${p.name}</div>
          <div class="person-sub">${p.role ? `<span>${p.role}</span>` : ''}${locBadge}</div>
        </div>
        <div class="card-actions">
          <button class="btn btn-ghost btn-sm" onclick="openEdit('${p.id}')">Edit</button>
          <button class="btn btn-red btn-sm" onclick="del('${p.id}')">Remove</button>
        </div>
      </div>
      <div class="stints">${rows}</div>
    </div>`;
  }).join('');

  el.innerHTML = header + cards;
}

function addPerson() {
  const name = document.getElementById('aname').value.trim();
  const role = document.getElementById('arole').value.trim();
  if (!name || !role) { toast('Name and role required', 'err'); return; }
  const p = { id: Date.now().toString(), name, role, loc: document.getElementById('aloc').value };
  for (let i = 1; i <= 3; i++) {
    p[`c${i}n`] = document.getElementById(`c${i}n`).value.trim();
    p[`c${i}s`] = document.getElementById(`c${i}s`).value;
    p[`c${i}e`] = document.getElementById(`c${i}e`).value;
  }
  const d = load(); d.push(p); save(d);
  clearForm();
  toast(`${name} saved`, 'ok');
  go('search');
}

function clearForm() {
  ['aname','arole','c1n','c1s','c1e','c2n','c2s','c2e','c3n','c3s','c3e'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('aloc').selectedIndex = 0;
}

function del(id) {
  save(load().filter(p => p.id !== id));
  search();
  toast('Removed', 'ok');
}

// Edit modal
function openEdit(id) {
  const p = load().find(x => x.id === id);
  if (!p) return;
  document.getElementById('editId').value = id;
  document.getElementById('ename').value = p.name || '';
  document.getElementById('erole').value = p.role || '';
  const locSel = document.getElementById('eloc');
  locSel.value = p.loc || '';
  for (let i = 1; i <= 3; i++) {
    document.getElementById(`ec${i}n`).value = p[`c${i}n`] || '';
    document.getElementById(`ec${i}s`).value = p[`c${i}s`] || '';
    document.getElementById(`ec${i}e`).value = p[`c${i}e`] || '';
  }
  document.getElementById('editModal').classList.add('open');
}

function closeModal() {
  document.getElementById('editModal').classList.remove('open');
}

function saveEdit() {
  const id = document.getElementById('editId').value;
  const name = document.getElementById('ename').value.trim();
  const role = document.getElementById('erole').value.trim();
  if (!name || !role) { toast('Name and role required', 'err'); return; }
  const data = load();
  const idx = data.findIndex(p => p.id === id);
  if (idx === -1) return;
  data[idx] = { ...data[idx], name, role, loc: document.getElementById('eloc').value };
  for (let i = 1; i <= 3; i++) {
    data[idx][`c${i}n`] = document.getElementById(`ec${i}n`).value.trim();
    data[idx][`c${i}s`] = document.getElementById(`ec${i}s`).value;
    data[idx][`c${i}e`] = document.getElementById(`ec${i}e`).value;
  }
  save(data);
  closeModal();
  search();
  toast('Saved', 'ok');
}

function deleteFromModal() {
  const id = document.getElementById('editId').value;
  if (!confirm('Remove this person?')) return;
  save(load().filter(p => p.id !== id));
  closeModal();
  search();
  toast('Removed', 'ok');
}

// Close modal on overlay click
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});

function parsePeople(text) {
  const lines = text.split('\n').filter(l => l.trim());
  const people = [];
  for (let i = 1; i < lines.length; i++) {
    const c = lines[i].split(',').map(s => s.trim());
    if (!c[0] || !c[2]) continue;
    // Name, Location, Role, C1name, C1start, C1end, C2name, C2start, C2end, C3name, C3start, C3end
    const p = { id: Date.now() + '_' + i, name: c[0], loc: c[1] || '', role: c[2] || '' };
    [[3,4,5,1],[6,7,8,2],[9,10,11,3]].forEach(([cn,cs,ce,idx]) => {
      p[`c${idx}n`] = c[cn] || ''; p[`c${idx}s`] = c[cs] || ''; p[`c${idx}e`] = c[ce] || '';
    });
    people.push(p);
  }
  return people;
}

function handleCSV(ev) {
  const file = ev.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const incoming = parsePeople(e.target.result);
    if (!incoming.length) { toast('CSV appears empty or malformed', 'err'); return; }

    let final;
    if (uploadMode === 'replace') {
      final = incoming;
    } else {
      // Append: skip duplicates by name (case-insensitive)
      const existing = load();
      const existingNames = new Set(existing.map(p => p.name.toLowerCase()));
      const newOnly = incoming.filter(p => !existingNames.has(p.name.toLowerCase()));
      final = [...existing, ...newOnly];
      const skipped = incoming.length - newOnly.length;
      if (skipped > 0) toast(`${newOnly.length} added, ${skipped} skipped (already exist)`, 'ok');
    }

    save(final);
    document.getElementById('upstatus').textContent = `${final.length} people in database`;
    if (uploadMode === 'replace') toast(`${incoming.length} people imported`, 'ok');
    go('search');
  };
  reader.readAsText(file);
  ev.target.value = '';
}

const dz = document.getElementById('dropzone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('over'); const f = e.dataTransfer.files[0]; if (f) handleCSV({ target: { files: [f] } }); });

function clearAll() {
  if (!confirm('Clear all people from the database?')) return;
  save([]);
  toast('Cleared', 'ok');
  search();
}

function toast(msg, type = 'ok') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 2800);
}

updateMeta();
</script>
</body>
</html>
